<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.daun.word.domain.assignment.domain.repository.AssignmentRepository">

    <resultMap id="assignmentMap" type="Assignment">
        <constructor>
            <idArg column="id" name="id" javaType="int"/>
            <arg column="problem_id" name="problem" javaType="Problem"
                 select="com.daun.word.domain.problem.domain.repository.ProblemRepository.findById"/>
            <arg column="assign_from" name="assignFrom" javaType="Email"/>
            <arg column="assign_to" name="assignTo" javaType="Email"/>
            <arg column="start_date_time" name="startDateTime" javaType="LocalDateTime"/>
            <arg column="end_date_time" name="endDateTime" javaType="LocalDateTime"/>
            <arg column="open_yn" name="openYn" javaType="String"/>
            <arg column="open_date_time" name="openDateTime" javaType="LocalDateTime"/>
            <arg column="complete_yn" name="completeYn" javaType="String"/>
            <arg column="complete_date_time" name="completeDateTime" javaType="LocalDateTime"/>
            <arg column="created_at" name="createdAt" javaType="LocalDateTime"/>
            <arg column="updated_at" name="updatedAt" javaType="LocalDateTime"/>
        </constructor>
    </resultMap>

    <select id="findById" resultMap="assignmentMap">
        select a.id                ,
               a.assign_from       ,
               a.assign_to         ,
               a.start_date_time   ,
               a.end_date_time     ,
               a.open_yn           ,
               a.open_date_time    ,
               a.complete_yn       ,
               a.complete_date_time,
               a.created_at        ,
               a.updated_at        ,
               p.id                 as problem_id
        from assignment as a
                 left join problem p on a.problem_id = p.id
        where a.id = #{id.value};
    </select>

    <insert id="save" parameterType="Assignment" useGeneratedKeys="true"
            keyColumn="id" keyProperty="assignment.id">
        INSERT INTO assignment
        (
        <if test="assignment.id != null">
            id,
        </if>
        problem_id,
        assign_from,
        assign_to,
        start_date_time,
        end_date_time
        )
        VALUES (
        <if test="assignment.id != null">
            #{assignment.id},
        </if>
        #{assignment.problem.id},
        #{assignment.assignFrom},
        #{assignment.assignTo},
        #{assignment.startDateTime},
        #{assignment.endDateTime}
        )
        ON DUPLICATE KEY
        UPDATE
        problem_id = #{assignment.problem.id},
        assign_from = #{assignment.assignFrom},
        assign_to = #{assignment.assignTo},
        start_date_time = #{assignment.startDateTime},
        end_date_time = #{assignment.endDateTime},
        open_yn = #{assignment.openYn},
        open_date_time = #{assignment.openDateTime},
        complete_yn = #{assignment.completeYn},
        complete_date_time = #{assignment.completeDateTime},
        updated_at = sysdate()
        <selectKey keyColumn="id,open_yn,open_date_time,complete_yn,complete_date_time,created_at,updated_at"
                   keyProperty="assignment.id,assignment.openYn,assignment.openDateTime,assignment.completeYn,assignment.completeDateTime,assignment.createdAt,assignment.updatedAt"
                   resultType="java.util.HashMap" order="AFTER">
            SELECT assignment.id,
            assignment.open_yn,
            assignment.open_date_time,
            assignment.complete_yn,
            assignment.complete_date_time,
            assignment.created_at,
            assignment.updated_at
            FROM assignment as assignment
            WHERE assignment.id =
            <if test="assignment.id != null">
                #{assignment.id}
            </if>
            <if test="assignment.id == null">
                LAST_INSERT_ID()
            </if>
        </selectKey>
    </insert>
</mapper>
