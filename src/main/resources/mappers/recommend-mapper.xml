<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.daun.word.domain.recommend.domain.repository.RecommendRepository">

    <resultMap id="recommendMap" type="Recommend">
        <constructor>
            <idArg column="globalId" name="globalId"/>
            <arg column="problem_id" name="problem" javaType="Problem"
                 select="com.daun.word.domain.problem.domain.repository.ProblemRepository.findById"/>
            <arg column="email" name="member" javaType="Member"
                 select="com.daun.word.domain.member.domain.repository.MemberRepository.findByEmail"/>
            <arg column="recommended_count" name="recommendedCount"/>
            <arg column="choose_yn" name="chooseYn" javaType="YesNo" typeHandler="YesNoTypeHandler"/>
            <arg column="choose_date_time" name="chooseDateTime" javaType="LocalDateTime"/>
            <arg column="created_at" name="createdAt" javaType="LocalDateTime"/>
            <arg column="updated_at" name="updatedAt" javaType="LocalDateTime"/>
        </constructor>
    </resultMap>

    <insert id="save" parameterType="Recommend" useGeneratedKeys="true" keyColumn="globalId" keyProperty="recommend.globalId">
        insert into recommend
        (
        problem_id,
        email
        <if test="recommend.globalId != null">
            ,globalId
            ,recommended_count
            ,choose_yn
            ,choose_date_time
        </if>
        )
        values
        (
        #{recommend.problem.globalId},
        #{recommend.member.email}
        <if test="recommend.globalId != null">
            ,#{recommend.globalId}
            ,#{recommend.recommendedCount}
            ,#{recommend.chooseYn}
            ,#{recommend.chooseDateTime}
        </if>
        )
        on duplicate key update
        problem_id = #{recommend.problem.globalId},
        email = #{recommend.member.email},
        recommended_count = #{recommend.recommendedCount},
        choose_yn = #{recommend.chooseYn},
        choose_date_time = #{recommend.chooseDateTime},
        updated_at = sysdate()
        <selectKey keyColumn="globalId,created_at,updated_at"
                   keyProperty="recommend.globalId,recommend.createdAt,recommend.updatedAt"
                   resultType="java.util.HashMap" order="AFTER">
            select
            r.globalId,
            r.created_at,
            r.updated_at
            from recommend as r
            WHERE r.globalId =
            <if test="recommend.globalId != null">
                #{recommend.globalId}
            </if>
            <if test="recommend.globalId == null">
                LAST_INSERT_ID()
            </if>
        </selectKey>
    </insert>

    <select id="findById" resultMap="recommendMap">
        select r.globalId,
               r.problem_id,
               r.email,
               r.recommended_count,
               r.choose_yn,
               r.choose_date_time,
               r.created_at,
               r.updated_at
        from recommend as r
        where r.globalId = #{recommendGlobalId.value}
    </select>

    <select id="findByMemberAndProblem" resultMap="recommendMap">
        select r.globalId,
               r.problem_id,
               r.email,
               r.recommended_count,
               r.choose_yn,
               r.choose_date_time,
               r.created_at,
               r.updated_at
        from recommend as r
        where r.email = #{member.email}
          and r.problem_id = #{problem.globalId.value}
    </select>

    <select id="findByMemberAndProblems" resultMap="recommendMap">
        select
        r.globalId,
        r.problem_id,
        r.email,
        r.recommended_count,
        r.choose_yn,
        r.choose_date_time,
        r.created_at,
        r.updated_at
        from recommend as r
        where r.email = #{member.email}
        and r.problem_id in
        <foreach item="problem" collection="problems" open="(" separator="," close=")">
            #{problem.globalId}
        </foreach>
    </select>

    <select id="findByMembersWhereCreatedBefore" resultMap="recommendMap">
        select r.globalId,
        r.problem_id,
        r.email,
        r.recommended_count,
        r.choose_yn,
        r.choose_date_time,
        r.created_at,
        r.updated_at
        from recommend as r
        where r.email in
        <foreach item="member" collection="members" open="(" separator="," close=")">
            #{member.email}
        </foreach>
        <![CDATA[
          and r.updated_at >= #{date}
        ]]>
    </select>
</mapper>
